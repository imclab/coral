#!/usr/bin/env ruby -rubygems
## Render markup from a file and output HTML.
#
# This script facilitates using the "github-markup" library and configures
# Markdown processing to be the same as on GitHub.com.

file = ARGV[0]

unless file and File.exist? file
  warn "usage: #$0 <file>"
  exit 2
end

begin
  require 'github/markup'
rescue LoadError
  abort $!.message
end

renderer = nil
html_options = { }
markdown_options = {
  :autolink           => true,
  :no_intra_emphasis  => true,
  :fenced_code_blocks => true,
}

html_renderer = lambda {
  renderer ||= begin
    class TocHTML < Redcarpet::Render::HTML
      def header text, level
        href = text.gsub(/<.+?>/, '').strip.gsub(/\s+/, '-').downcase
        anchor = %(<a name="#{href}" href="\##{href}"></a>)
        %(<h#{level}>#{anchor}#{text}</h#{level}>\n)
      end
    end

    begin
      old_level, $-w = $-w, nil
      require 'pygments'
    rescue LoadError
      warn "error loading pygments.rb; no syntax highlighting available"
      TocHTML
    else
      require 'cgi'
      Class.new(TocHTML) do
        def block_code(code, language)
          if language
            Pygments.highlight(code, :lexer => language)
          else
            # can't call super: https://github.com/tanoku/redcarpet/issues/51
            "<pre><code>#{CGI.escapeHTML code}</code></pre>"
          end
        end
      end
    ensure
      $-w = old_level
    end
  end
}

GitHub::Markup.markup(:redcarpet, /md|mkdn?|mdown|markdown/) do |content|
  markdown = Redcarpet::Markdown.new \
    html_renderer.call.new(html_options),
    markdown_options

  markdown.render(content)
end

puts GitHub::Markup.render(file)
